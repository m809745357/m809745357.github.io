(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{165:function(t,s,a){t.exports=a.p+"assets/img/image-20180913185026947.e45c693c.png"},166:function(t,s,a){t.exports=a.p+"assets/img/image-20180913185437942.f1b6ff43.png"},167:function(t,s,a){t.exports=a.p+"assets/img/image-20180913185819314.917084f4.png"},168:function(t,s,a){t.exports=a.p+"assets/img/image-20180913185856473.4b505d50.png"},169:function(t,s,a){t.exports=a.p+"assets/img/image-20180914124705842.16ee0ab3.png"},170:function(t,s,a){t.exports=a.p+"assets/img/image-20180914125130578.4ab92e91.png"},171:function(t,s,a){t.exports=a.p+"assets/img/image-20180914130912067.0a1994d7.png"},172:function(t,s,a){t.exports=a.p+"assets/img/image-20180914133816963.287553f5.png"},173:function(t,s,a){t.exports=a.p+"assets/img/image-20180914133937739.9375e121.png"},174:function(t,s,a){t.exports=a.p+"assets/img/image-20180914132319923.fd90b0fe.png"},175:function(t,s,a){t.exports=a.p+"assets/img/image-20180914132530077.b26f575d.png"},176:function(t,s,a){t.exports=a.p+"assets/img/image-20180914140355472.15404fd7.png"},179:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"基于-puppeteer-生成分享海报功能的安装和使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于-puppeteer-生成分享海报功能的安装和使用","aria-hidden":"true"}},[this._v("#")]),this._v(" 基于 Puppeteer 生成分享海报功能的安装和使用")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"思考怎么去生成图片"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#思考怎么去生成图片","aria-hidden":"true"}},[this._v("#")]),this._v(" 思考怎么去生成图片")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("用 php 处理图片的水印去实现，比较复杂，需要定位。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("用 canvas 去处理 html dom 节点保存输出图片，需要处理定位，小程序同理。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("使用 js 插件把 html 转成 canves 在转成 图片输出")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("使用 puppeteer 无头Chrome节点API 工具去实现。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"本地部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#本地部署","aria-hidden":"true"}},[this._v("#")]),this._v(" 本地部署")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"安装-puppeteer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-puppeteer","aria-hidden":"true"}},[this._v("#")]),this._v(" 安装 puppeteer")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{attrs:{class:"token function"}},[this._v("mkdir")]),this._v(" ~/code/puppeteer "),s("span",{attrs:{class:"token operator"}},[this._v("&&")]),this._v(" "),s("span",{attrs:{class:"token function"}},[this._v("cd")]),this._v(" ~/code/puppeteer\n\nyarn add puppeteer\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(165),alt:"image-20180913185026947"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{attrs:{class:"token keyword"}},[this._v("set")]),this._v(" PUPPETEER_SKIP_CHROMIUM_DOWNLOAD"),s("span",{attrs:{class:"token operator"}},[this._v("=")]),this._v("1\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("cnpm i puppeteer\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(166),alt:"image-20180913185437942"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"测试-puppeteer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试-puppeteer","aria-hidden":"true"}},[this._v("#")]),this._v(" 测试 puppeteer")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{attrs:{class:"token function"}},[this._v("touch")]),this._v(" example.js "),s("span",{attrs:{class:"token operator"}},[this._v("&&")]),this._v(" vim example.js\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" puppeteer "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'puppeteer'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" browser "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" puppeteer"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("launch")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" page "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" browser"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("newPage")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("goto")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'https://www.baidu.com'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("screenshot")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("path"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'example.png'")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" browser"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("close")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("node example.js\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(167),alt:"image-20180913185819314"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(168),alt:"image-20180913185856473"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"php-中使用-puppeteer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#php-中使用-puppeteer","aria-hidden":"true"}},[this._v("#")]),this._v(" php 中使用 puppeteer")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-php extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// 图片保存地址")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$imgFilePath")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("storage_path")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"app/public/activity-record/'),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token variable"}},[t._v("$activityRecord")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")])]),t._v("_"),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token variable"}},[t._v("$template")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('.png"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// js保存地址")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$jsFilePath")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"/public/activity-record/'),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token variable"}},[t._v("$activityRecord")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")])]),t._v("_"),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token variable"}},[t._v("$template")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('.js"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 访问地址")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$url")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'http://'")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("config")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'api.domains.mp'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"/activity/record/'),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token variable"}},[t._v("$activityRecord")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")])]),t._v("/share?template="),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token variable"}},[t._v("$template")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 创建文件")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$jsFileContents")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token heredoc-string string"}},[a("span",{attrs:{class:"token delimiter symbol"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<<<")]),t._v("EOF")]),t._v("\nconst puppeteer = require('puppeteer');\n\n(async () => {\nconst browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox']});\nconst page = await browser.newPage();\nawait page.setViewport({ width: 375, height: 667, deviceScaleFactor: 2, isMobile: true });\nawait page.goto('"),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token variable"}},[t._v("$url")])]),t._v("');\nawait page.screenshot({ path: '"),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token variable"}},[t._v("$imgFilePath")])]),t._v("' });\n\nawait browser.close();\n})();\n"),a("span",{attrs:{class:"token delimiter symbol"}},[t._v("EOF"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")])])]),t._v("\n\nStorage"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("put")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$jsFilePath")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$jsFileContents")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 主要也就是这一步比较的坑，填了很久很久")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 正式的环境需要指定node目录")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// exec('/usr/local/nodejs/bin/node ' . storage_path(\"app/$jsFilePath\"));")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 本地已经实现了")]),t._v("\n"),a("span",{attrs:{class:"token function"}},[t._v("exec")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'node '")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("storage_path")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"app/'),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token variable"}},[t._v("$jsFilePath")])]),t._v('"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 这里是上传到腾讯cos")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$disk")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" \\"),a("span",{attrs:{class:"token package"}},[t._v("Storage")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("disk")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'cosv5'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token variable"}},[t._v("$cosPath")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"jielong/activity/record/'),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token variable"}},[t._v("$activityRecord")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")])]),t._v("/t/"),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token variable"}},[t._v("$template")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('.png"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token variable"}},[t._v("$disk")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("put")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$cosPath")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("fopen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"'),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token variable"}},[t._v("$imgFilePath")])]),t._v('"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'rb'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"测试部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试部署","aria-hidden":"true"}},[this._v("#")]),this._v(" 测试部署")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"依赖错误"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#依赖错误","aria-hidden":"true"}},[this._v("#")]),this._v(" 依赖错误")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"libxcomposite-so-1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#libxcomposite-so-1","aria-hidden":"true"}},[this._v("#")]),this._v(" libXcomposite.so.1")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("error while loading shared libraries: libXcomposite.so.1: cannot open shared object file: No such file or directory")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("/home/puppeteer/node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome: error "),s("span",{attrs:{class:"token keyword"}},[this._v("while")]),this._v(" loading shared libraries: libXcomposite.so.1: cannot "),s("span",{attrs:{class:"token function"}},[this._v("open")]),this._v(" shared object file: No such "),s("span",{attrs:{class:"token function"}},[this._v("file")]),this._v(" or directory\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(169),alt:"image-20180914124705842"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("// 安装依赖\nyum "),s("span",{attrs:{class:"token function"}},[this._v("install")]),this._v(" pango.x86_64 libXcomposite.x86_64 libXcursor.x86_64 libXdamage.x86_64 libXext.x86_64 libXi.x86_64 libXtst.x86_64 cups-libs.x86_64 libXScrnSaver.x86_64 libXrandr.x86_64 GConf2.x86_64 alsa-lib.x86_64 atk.x86_64 gtk3.x86_64 -y\n\n// 安装字体\nyum "),s("span",{attrs:{class:"token function"}},[this._v("install")]),this._v(" ipa-gothic-fonts xorg-x11-fonts-100dpi xorg-x11-fonts-75dpi xorg-x11-utils xorg-x11-fonts-cyrillic xorg-x11-fonts-Type1 xorg-x11-fonts-misc -y\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"libatk-bridge-2-0-so-0"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#libatk-bridge-2-0-so-0","aria-hidden":"true"}},[this._v("#")]),this._v(" libatk-bridge-2.0.so.0")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("error while loading shared libraries: libatk-bridge-2.0.so.0: cannot open shared object file: No such file or directory")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("/home/puppeteer/node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome: error "),s("span",{attrs:{class:"token keyword"}},[this._v("while")]),this._v(" loading shared libraries: libatk-bridge-2.0.so.0: cannot "),s("span",{attrs:{class:"token function"}},[this._v("open")]),this._v(" shared object file: No such "),s("span",{attrs:{class:"token function"}},[this._v("file")]),this._v(" or directory\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(170),alt:"image-20180914125130578"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("ldd node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(171),alt:"image-20180914130912067"}})])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("// 网上发现了一个方式，安装一个 firefox 然后把依赖复制过去\nyum "),a("span",{attrs:{class:"token function"}},[t._v("install")]),t._v(" firefox-60.1.0-6.el6.centos.x86_64\n\n"),a("span",{attrs:{class:"token function"}},[t._v("cp")]),t._v(" /usr/lib64/firefox/bundled/lib64/libatk-bridge-2.0.so.0 /usr/lib64\n"),a("span",{attrs:{class:"token function"}},[t._v("cp")]),t._v(" /usr/lib64/firefox/bundled/lib64/libatspi.so.0 /usr/lib64\n"),a("span",{attrs:{class:"token function"}},[t._v("cp")]),t._v(" /usr/lib64/firefox/bundled/lib64/libgdk-3.so.0 /usr/lib64\n"),a("span",{attrs:{class:"token function"}},[t._v("cp")]),t._v(" /usr/lib64/firefox/bundled/lib64/libgtk-3.so.0 /usr/lib64\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(172),alt:"image-20180914133816963"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"libgl-so-1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#libgl-so-1","aria-hidden":"true"}},[this._v("#")]),this._v(" libGL.so.1")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("/home/puppeteer/node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome: error "),s("span",{attrs:{class:"token keyword"}},[this._v("while")]),this._v(" loading shared libraries: libGL.so.1: cannot "),s("span",{attrs:{class:"token function"}},[this._v("open")]),this._v(" shared object file: No such "),s("span",{attrs:{class:"token function"}},[this._v("file")]),this._v(" or directory\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("yum "),s("span",{attrs:{class:"token function"}},[this._v("install")]),this._v(" mesa-libGL.x86_64\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(173),alt:"image-20180914133937739"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("objdump -p node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(174),alt:"image-20180914132319923"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("strings /lib64/libc.so.6 "),s("span",{attrs:{class:"token operator"}},[this._v("|")]),s("span",{attrs:{class:"token function"}},[this._v("grep")]),this._v(" GLIBC_ \n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(175),alt:"image-20180914132530077"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("cnpm i puppeteer@1.4\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"版本错误"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#版本错误","aria-hidden":"true"}},[this._v("#")]),this._v(" 版本错误")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"libcairo-gobject-so-2-undefined-symbol-cairo-region-destroy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#libcairo-gobject-so-2-undefined-symbol-cairo-region-destroy","aria-hidden":"true"}},[this._v("#")]),this._v(" libcairo-gobject.so.2: undefined symbol: cairo_region_destroy")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("libcairo-gobject.so.2: undefined symbol: cairo_region_destroy\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"docker-部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-部署","aria-hidden":"true"}},[this._v("#")]),this._v(" Docker 部署")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"centos-安装-docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#centos-安装-docker","aria-hidden":"true"}},[this._v("#")]),this._v(" centos 安装 docker")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("yum "),s("span",{attrs:{class:"token function"}},[this._v("install")]),this._v(" docker-io\n"),s("span",{attrs:{class:"token function"}},[this._v("service")]),this._v(" docker start\nvim Dockerfile\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"docker-build-容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-build-容器","aria-hidden":"true"}},[this._v("#")]),this._v(" docker build 容器")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[this._v("FROM node:8-slim\n\n# See https://crbug.com/795759\nRUN apt-get update && apt-get install -yq libgconf-2-4\n\n# Install latest chrome dev package and fonts to support major charsets (Chinese, Japanese, Arabic, Hebrew, Thai and a few others)\n# Note: this installs the necessary libs to make the bundled version of Chromium that Puppeteer\n# installs, work.\nRUN apt-get update && apt-get install -y wget --no-install-recommends \\\n    && wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - \\\n    && sh -c 'echo \"deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main\" >> /etc/apt/sources.list.d/google.list' \\\n    && apt-get update \\\n    && apt-get install -y google-chrome-unstable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst ttf-freefont \\\n      --no-install-recommends \\\n    && rm -rf /var/lib/apt/lists/* \\\n    && apt-get purge --auto-remove -y curl \\\n    && rm -rf /src/*.deb\n\n# It's a good idea to use dumb-init to help prevent zombie chrome processes.\nADD https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64 /usr/local/bin/dumb-init\nRUN chmod +x /usr/local/bin/dumb-init\n\n# Uncomment to skip the chromium download when installing puppeteer. If you do,\n# you'll need to launch puppeteer with:\n#     browser.launch({executablePath: 'google-chrome-unstable'})\n# ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD true\n\n# Install puppeteer so it's available in the container.\nRUN npm i puppeteer\n\n# Add user so we don't need --no-sandbox.\nRUN groupadd -r pptruser && useradd -r -g pptruser -G audio,video pptruser \\\n    && mkdir -p /home/pptruser/Downloads \\\n    && chown -R pptruser:pptruser /home/pptruser \\\n    && chown -R pptruser:pptruser /node_modules\n\n# Run everything after as non-privileged user.\nUSER pptruser\n\nENTRYPOINT [\"dumb-init\", \"--\"]\nCMD [\"google-chrome-unstable\"]\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("docker build -t puppeteer-chrome-linux "),s("span",{attrs:{class:"token keyword"}},[this._v(".")]),this._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"创建-puppeteer-sh"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建-puppeteer-sh","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建 puppeteer.sh")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n"),a("span",{attrs:{class:"token function"}},[t._v("readonly")]),t._v(" USAGE"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token string"}},[t._v('"Usage: puppeteer.sh yourfile.js"')]),t._v("\n\nbasepath"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token variable"}},[a("span",{attrs:{class:"token variable"}},[t._v("$(")]),a("span",{attrs:{class:"token function"}},[t._v("pwd")]),a("span",{attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\nlocal_path"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token string"}},[t._v('"'),a("span",{attrs:{class:"token variable"}},[t._v("$basepath")]),t._v('/storage/app/public/activity-record/"')]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" -z "),a("span",{attrs:{class:"token string"}},[t._v('"'),a("span",{attrs:{class:"token variable"}},[t._v("$1")]),t._v('"')]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"File not specified."')]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$USAGE")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("exit")]),t._v(" 0\n"),a("span",{attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"Running '),a("span",{attrs:{class:"token variable"}},[t._v("$1")]),t._v(' in Puppeteer..."')]),t._v("\n\nfile"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token variable"}},[a("span",{attrs:{class:"token variable"}},[t._v("`")]),a("span",{attrs:{class:"token function"}},[t._v("cat")]),t._v(" $1"),a("span",{attrs:{class:"token variable"}},[t._v("`")])]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("# set -x # debug on")]),t._v("\ndocker run -it --net"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("host -v "),a("span",{attrs:{class:"token variable"}},[t._v("$local_path")]),t._v(":/home/pptruser/Downloads --privileged"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("true --rm --cap-add"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("SYS_ADMIN \\\n  --name puppeteer-chrome puppeteer-chrome-linux \\\n  node -e "),a("span",{attrs:{class:"token string"}},[t._v('"'),a("span",{attrs:{class:"token variable"}},[t._v("$file")]),t._v('"')]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"puppeteer-sh-生成图片"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#puppeteer-sh-生成图片","aria-hidden":"true"}},[this._v("#")]),this._v(" puppeteer.sh 生成图片")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("./puppeteer.sh example.js\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"php-去调用-puppeteer-sh"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#php-去调用-puppeteer-sh","aria-hidden":"true"}},[this._v("#")]),this._v(" php 去调用 puppeteer.sh")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-php extra-class"},[s("pre",{pre:!0,attrs:{class:"language-php"}},[s("code",[s("span",{attrs:{class:"token function"}},[this._v("exec")]),s("span",{attrs:{class:"token punctuation"}},[this._v("(")]),s("span",{attrs:{class:"token double-quoted-string string"}},[this._v('"./puppeteer.sh example.js"')]),s("span",{attrs:{class:"token punctuation"}},[this._v(")")]),this._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("思考: php 如何使用 root 权限")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"正式部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#正式部署","aria-hidden":"true"}},[this._v("#")]),this._v(" 正式部署")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"安装-express-puppeteer-等工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-express-puppeteer-等工具","aria-hidden":"true"}},[this._v("#")]),this._v(" 安装 express puppeteer 等工具")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{attrs:{class:"token function"}},[this._v("mkdir")]),this._v(" /home/www/puppeteer\n"),s("span",{attrs:{class:"token function"}},[this._v("cd")]),this._v(" /home/www/puppeteer\n// chrome 无头\ncnpm i puppeteer\n// 腾讯cos\ncnpm i cos-nodejs-sdk-v5 --save\n// express\ncnpm i express\n// 环境变量\ncnpm i dotenv\n// pm2进程管理\ncnpm "),s("span",{attrs:{class:"token function"}},[this._v("install")]),this._v(" pm2 -g\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"express-搭建-api-服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#express-搭建-api-服务器","aria-hidden":"true"}},[this._v("#")]),this._v(" express 搭建 api 服务器")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" express "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'express'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("express")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token comment"}},[t._v("// 引入json解析中间件")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" puppeteer "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'puppeteer'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" bodyParser "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'body-parser'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("COS")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'cos-nodejs-sdk-v5'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" basePath "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("cwd")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dotenv "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'dotenv'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("config")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" path"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token template-string"}},[a("span",{attrs:{class:"token string"}},[t._v("`")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("basePath"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v("/../jielong_mp/.env`")])]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" cos "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("COS")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    AppId"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token constant"}},[t._v("COSV5_APP_ID")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    SecretId"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token constant"}},[t._v("COSV5_SECRET_ID")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    SecretKey"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token constant"}},[t._v("COSV5_SECRET_KEY")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_APP_ID = 1251581441")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_SECRET_ID = AKIDbFnBPV9N6g8PYY91TkJp6D92pT0NIpoc")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_SECRET_KEY = mOp9MRMF2eN0Tq26zhEaZO3XsJk3CA1i")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_TIMEOUT = 60")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_CONNECT_TIMEOUT = 60")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_BUCKET = kemanyun")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_REGION = ap - shanghai")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_CDN = #https://{your-bucket-name}-{your-app-id}.file.myqcloud.com")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// COSV5_SCHEME = https")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 添加json解析")]),t._v("\napp"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("use")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bodyParser"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("json")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\napp"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("use")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bodyParser"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("urlencoded")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("extended"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("false")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\napp"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("post")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'/api/puppeteer'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" activity_record_id "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" req"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("activity_record_id"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" template "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" req"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("template"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" path "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token template-string"}},[a("span",{attrs:{class:"token string"}},[t._v("`")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("basePath"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v("/../jielong_mp/storage/app/public/activity-record/")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("activity_record_id"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v("_")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("template"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v(".png`")])]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mp_domain "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token constant"}},[t._v("MP_DOMAIN")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" url "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token template-string"}},[a("span",{attrs:{class:"token string"}},[t._v("`http:/")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("mp_domain"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v("/activity/record/")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("activity_record_id"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v("/share?template=")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("template"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v("`")])]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" browser "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" puppeteer"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("launch")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" args"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token string"}},[t._v("'--no-sandbox'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'--disable-setuid-sandbox'")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token constant"}},[t._v("APP_ENV")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'local'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" browser "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" puppeteer"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("launch")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" page "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" browser"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("newPage")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("setViewport")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" width"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("375")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" height"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("667")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deviceScaleFactor"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("2")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" isMobile"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("goto")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("screenshot")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" path"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" path "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" browser"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("close")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 分片上传")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" cos"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("sliceUploadFile")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            Bucket"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token constant"}},[t._v("COSV5_BUCKET")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            Region"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token constant"}},[t._v("COSV5_REGION")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            Key"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" process"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token constant"}},[t._v("COSV5_BUCKET_PREFIX")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token template-string"}},[a("span",{attrs:{class:"token string"}},[t._v("`/activity/record/")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("activity_record_id"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v("/t/")]),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("template"),a("span",{attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{attrs:{class:"token string"}},[t._v(".png`")])]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            FilePath"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" path\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("status")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("201")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("json")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            message"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'创建图片成功'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            status_code"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'201'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("listen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("3000")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("log")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Example app listening on port 3000!'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"pm2-来管理-express"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pm2-来管理-express","aria-hidden":"true"}},[this._v("#")]),this._v(" pm2 来管理 express")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("pm2 start index.js\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(176),alt:"image-20180914140355472"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"php-调用接口来实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#php-调用接口来实现","aria-hidden":"true"}},[this._v("#")]),this._v(" php 调用接口来实现")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-php extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),a("span",{attrs:{class:"token package"}},[t._v("GuzzleHttp"),a("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Client")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n"),a("span",{attrs:{class:"token variable"}},[t._v("$guzzleCLient")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("Client")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token variable"}},[t._v("$res")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$guzzleCLient")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("post")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'http://127.0.0.1:3000/api/puppeteer'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'form_params'")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'activity_record_id'")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$activityRecord")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'template'")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$template")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"扩展分享"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#扩展分享","aria-hidden":"true"}},[this._v("#")]),this._v(" 扩展分享")])}],e=a(0),r=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://segmentfault.com/a/1190000016121303",target:"_blank",rel:"noopener noreferrer"}},[t._v("轻松生成小程序分享海报"),a("OutboundLink")],1)])]),t._v(" "),t._m(4),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://html2canvas.hertzen.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("html2canvas"),a("OutboundLink")],1)])]),t._v(" "),t._m(5),t._v(" "),a("p",[t._v("其实就是用谷歌浏览器去打开网页然后截图保存到本地")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/GoogleChrome/puppeteer",target:"_blank",rel:"noopener noreferrer"}},[t._v("GoogleChrome/puppeteer"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://segmentfault.com/a/1190000011382062",target:"_blank",rel:"noopener noreferrer"}},[t._v("centos安装使用puppeteer和headless chrome"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("经过前后端同学的紧张讨论下，最后勇敢的使用了第4个方案：")]),t._v(" "),a("p",[t._v("在程序员界没学习一项新的知识都需要打印一段 Hello World，那么我们就开始实现第一步")]),t._v(" "),t._m(6),t._v(" "),a("p",[t._v("首先熟练的打开了 iterm 工具执行命令")]),t._v(" "),t._m(7),t._v(" "),t._m(8),t._m(9),t._v(" "),a("p",[t._v("这通常是由于 Chromium 浏览器未正常下载到而引起的。这个时候，我们可以先设定环境变量，跳过安装 Chromium 的步骤，然后手动翻墙去下载：")]),t._v(" "),t._m(10),a("p",[t._v("然后还需要手动的指定执行的目录，这里我们不多的去介绍了。")]),t._v(" "),a("p",[t._v("直接动用淘宝镜像，果然可以，感谢马爸爸。")]),t._v(" "),t._m(11),t._m(12),t._v(" "),t._m(13),t._v(" "),a("p",[t._v("然后就是用官方提供的方式来测试。")]),t._v(" "),a("p",[t._v("创建 example.js 文件。")]),t._v(" "),t._m(14),t._m(15),t._m(16),t._m(17),t._v(" "),a("p",[t._v("图片成功的显示出来了 😄")]),t._v(" "),t._m(18),t._v(" "),t._m(19),t._v(" "),a("p",[t._v("然后就是放到PHP代码里面。这里我就直接截取了部分代码讲一下思路。")]),t._v(" "),t._m(20),a("p",[t._v("好了本地调试通过了，那就开始走测试环境，这里开始就不停的出现问题，依赖问题等等都出来了。")]),t._v(" "),t._m(21),t._v(" "),a("p",[t._v("首先是测试换进 Centos 6.7 版本")]),t._v(" "),t._m(22),t._v(" "),t._m(23),t._v(" "),t._m(24),t._v(" "),t._m(25),t._m(26),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/GoogleChrome/puppeteer/issues/560#issuecomment-325224766",target:"_blank",rel:"noopener noreferrer"}},[t._v("issuess"),a("OutboundLink")],1)]),t._v(" "),t._m(27),t._m(28),t._v(" "),t._m(29),t._v(" "),t._m(30),t._m(31),t._v(" "),t._m(32),t._m(33),t._v(" "),t._m(34),t._m(35),t._v(" "),t._m(36),t._v(" "),t._m(37),t._m(38),t._m(39),t._v(" "),a("p",[t._v("运行下面的命令行可以看到需要 GLIBC_2.14 GLIBC_2.16")]),t._v(" "),t._m(40),t._m(41),t._v(" "),a("p",[t._v("发现只支持到 GLIBC_2.12")]),t._v(" "),t._m(42),t._m(43),t._v(" "),a("p",[t._v("所以需要安装 GLIBC_2.14")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/kevingrace/p/8744417.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("libc.so.6: version 'GLIBC_2.14' not found报错提示的解决方案"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("但是GLIBC_2.16在机器上怎么装都装不上，所以后来放弃了。")]),t._v(" "),a("p",[t._v("解决方案是安装低版本的puppeteer 大概是 1.4 以下的版本")]),t._v(" "),t._m(44),a("p",[t._v("好像没有找到不需要 GLIBC_2.14 的包")]),t._v(" "),a("p",[t._v("最后是安装了 GLIBC_2.14 然后执行命令之后发现了一个问题。")]),t._v(" "),t._m(45),t._v(" "),t._m(46),t._v(" "),t._m(47),a("p",[t._v("后面反正是没有找到解决方案。")]),t._v(" "),t._m(48),t._v(" "),t._m(49),t._v(" "),t._m(50),t._m(51),t._v(" "),t._m(52),t._m(53),t._m(54),t._v(" "),a("p",[t._v("然后创建了一个文件 puppeteer.sh")]),t._v(" "),t._m(55),t._m(56),t._v(" "),a("p",[t._v("使用 puppeteer.sh 来调用 example.js")]),t._v(" "),t._m(57),t._m(58),t._v(" "),t._m(59),t._m(60),t._v(" "),a("p",[t._v("会发现一个问题，在命令行的时候是可以执行的，但是在网页上面是不行，最后发现是权限问题。命令行是 root 权限但是在网站的时候是 www 权限，因为权限是通过 nginx 的用户来定的。然后又想到一个方法是用队列执行，队列是可以使用 root 权限去执行的，没想到是可以的。但是队列获取不到队列执行的结果，所以每次执行一次就不能用了，需要手动的重启队列，最后还是放弃了。")]),t._v(" "),t._m(61),t._v(" "),a("p",[t._v("Centos 7.4 一切没有问题。")]),t._v(" "),a("p",[t._v("主要是一个问题，生成图片的时候文字有方格乱码，解决的方案是使用本地的字体库。")]),t._v(" "),a("p",[t._v("目前使用队列来执行代码，但是无法实时的更新，所以尝试 sleep 方法，但是还是不能很好的解决这个问题。")]),t._v(" "),a("p",[t._v("思考后 node express 开发一个 api 来生成图片。")]),t._v(" "),t._m(62),t._v(" "),t._m(63),t._m(64),t._v(" "),a("p",[t._v("index.js")]),t._v(" "),t._m(65),t._m(66),t._v(" "),t._m(67),t._m(68),t._v(" "),t._m(69),t._v(" "),t._m(70),t._m(71),t._v(" "),a("p",[t._v("最后我才发现了已经有大神有解决方案了，干得漂亮。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/nesk/rialto",target:"_blank",rel:"noopener noreferrer"}},[t._v("nesk/rialto"),a("OutboundLink")],1),t._v(" 工作原理是创建一个Node进程并通过 socket 与它通信。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://laravel-china.org/topics/14699/extended-recommendation-php-bridge-of-puphpeteerchrome-headless-browser-puphpeteer-project",target:"_blank",rel:"noopener noreferrer"}},[t._v("Puphpeteer：Chrome 无头浏览器 Puphpeteer 项目的 PHP 桥梁"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("目前线上使用接口，没有使用这个包")])])},n,!1,null,null,null);r.options.__file="installation-and-use-of-poster-poster-based-on-puppeteer.md";s.default=r.exports}}]);
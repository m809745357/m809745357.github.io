<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于 Puppeteer 生成分享海报功能的安装和使用 | Blog</title>
    <meta name="description" content="基于 Puppeteer 生成分享海报功能的安装和使用">
    
    <meta name="keywords" content="Puppeteer puppeteer 海报 分享">
    <link rel="preload" href="/assets/css/styles.e418f3b2.css" as="style"><link rel="preload" href="/assets/js/app.e418f3b2.js" as="script"><link rel="preload" href="/assets/js/6.351126f6.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.47b44045.css"><link rel="prefetch" href="/assets/js/1.47b44045.js"><link rel="prefetch" href="/assets/css/2.styles.f515390e.css"><link rel="prefetch" href="/assets/js/2.f515390e.js"><link rel="prefetch" href="/assets/js/3.13653eae.js"><link rel="prefetch" href="/assets/js/4.ddbf7069.js"><link rel="prefetch" href="/assets/js/5.6fc87358.js">
    <link rel="stylesheet" href="/assets/css/styles.e418f3b2.css"><link rel="stylesheet" href="/assets/css/1.styles.47b44045.css"><link rel="stylesheet" href="/assets/css/2.styles.f515390e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/coding/" class="nav-link router-link-active">Coding</a></div><div class="nav-item"><a href="/photography/" class="nav-link">Photography</a></div><div class="nav-item"><a href="/guitar/" class="nav-link">Guitar</a></div><div class="nav-item"><a href="https://m809745357.github.io/resume/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Resume
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/m809745357/m809745357.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/coding/" class="nav-link router-link-active">Coding</a></div><div class="nav-item"><a href="/photography/" class="nav-link">Photography</a></div><div class="nav-item"><a href="/guitar/" class="nav-link">Guitar</a></div><div class="nav-item"><a href="https://m809745357.github.io/resume/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Resume
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/m809745357/m809745357.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>基于 Puppeteer 生成分享海报功能的安装和使用</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#思考怎么去生成图片" class="sidebar-link">思考怎么去生成图片</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#本地部署" class="sidebar-link">本地部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#安装-puppeteer" class="sidebar-link">安装 puppeteer</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#测试-puppeteer" class="sidebar-link">测试 puppeteer</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#php-中使用-puppeteer" class="sidebar-link">php 中使用 puppeteer</a></li></ul></li><li><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#测试部署" class="sidebar-link">测试部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#依赖错误" class="sidebar-link">依赖错误</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#版本错误" class="sidebar-link">版本错误</a></li></ul></li><li><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#docker-部署" class="sidebar-link">Docker 部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#centos-安装-docker" class="sidebar-link">centos 安装 docker</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#docker-build-容器" class="sidebar-link">docker build 容器</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#创建-puppeteer-sh" class="sidebar-link">创建 puppeteer.sh</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#puppeteer-sh-生成图片" class="sidebar-link">puppeteer.sh 生成图片</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#php-去调用-puppeteer-sh" class="sidebar-link">php 去调用 puppeteer.sh</a></li></ul></li><li><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#正式部署" class="sidebar-link">正式部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#安装-express-puppeteer-等工具" class="sidebar-link">安装 express puppeteer 等工具</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#express-搭建-api-服务器" class="sidebar-link">express 搭建 api 服务器</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#pm2-来管理-express" class="sidebar-link">pm2 来管理 express</a></li><li class="sidebar-sub-header"><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#php-调用接口来实现" class="sidebar-link">php 调用接口来实现</a></li></ul></li><li><a href="/coding/installation-and-use-of-poster-poster-based-on-puppeteer.html#扩展分享" class="sidebar-link">扩展分享</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="基于-puppeteer-生成分享海报功能的安装和使用"><a href="#基于-puppeteer-生成分享海报功能的安装和使用" aria-hidden="true" class="header-anchor">#</a> 基于 Puppeteer 生成分享海报功能的安装和使用</h1> <h2 id="思考怎么去生成图片"><a href="#思考怎么去生成图片" aria-hidden="true" class="header-anchor">#</a> 思考怎么去生成图片</h2> <blockquote><p>用 php 处理图片的水印去实现，比较复杂，需要定位。</p></blockquote> <blockquote><p>用 canvas 去处理 html dom 节点保存输出图片，需要处理定位，小程序同理。</p></blockquote> <ul><li><a href="https://segmentfault.com/a/1190000016121303" target="_blank" rel="noopener noreferrer">轻松生成小程序分享海报<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <blockquote><p>使用 js 插件把 html 转成 canves 在转成 图片输出</p></blockquote> <ul><li><a href="http://html2canvas.hertzen.com/" target="_blank" rel="noopener noreferrer">html2canvas<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <blockquote><p>使用 puppeteer 无头Chrome节点API 工具去实现。</p></blockquote> <p>其实就是用谷歌浏览器去打开网页然后截图保存到本地</p> <ul><li><a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener noreferrer">GoogleChrome/puppeteer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://segmentfault.com/a/1190000011382062" target="_blank" rel="noopener noreferrer">centos安装使用puppeteer和headless chrome<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>经过前后端同学的紧张讨论下，最后勇敢的使用了第4个方案：</p> <p>在程序员界没学习一项新的知识都需要打印一段 Hello World，那么我们就开始实现第一步</p> <h2 id="本地部署"><a href="#本地部署" aria-hidden="true" class="header-anchor">#</a> 本地部署</h2> <p>首先熟练的打开了 iterm 工具执行命令</p> <h3 id="安装-puppeteer"><a href="#安装-puppeteer" aria-hidden="true" class="header-anchor">#</a> 安装 puppeteer</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> ~/code/puppeteer <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> ~/code/puppeteer

yarn add puppeteer
</code></pre></div><p><img src="/assets/img/image-20180913185026947.e45c693c.png" alt="image-20180913185026947"></p> <p>这通常是由于 Chromium 浏览器未正常下载到而引起的。这个时候，我们可以先设定环境变量，跳过安装 Chromium 的步骤，然后手动翻墙去下载：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">set</span> PUPPETEER_SKIP_CHROMIUM_DOWNLOAD<span class="token operator">=</span>1
</code></pre></div><p>然后还需要手动的指定执行的目录，这里我们不多的去介绍了。</p> <p>直接动用淘宝镜像，果然可以，感谢马爸爸。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cnpm i puppeteer
</code></pre></div><p><img src="/assets/img/image-20180913185437942.f1b6ff43.png" alt="image-20180913185437942"></p> <h3 id="测试-puppeteer"><a href="#测试-puppeteer" aria-hidden="true" class="header-anchor">#</a> 测试 puppeteer</h3> <p>然后就是用官方提供的方式来测试。</p> <p>创建 example.js 文件。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">touch</span> example.js <span class="token operator">&amp;&amp;</span> vim example.js
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">screenshot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>path<span class="token punctuation">:</span> <span class="token string">'example.png'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>node example.js
</code></pre></div><p><img src="/assets/img/image-20180913185819314.917084f4.png" alt="image-20180913185819314"></p> <p>图片成功的显示出来了 😄</p> <p><img src="/assets/img/image-20180913185856473.4b505d50.png" alt="image-20180913185856473"></p> <h3 id="php-中使用-puppeteer"><a href="#php-中使用-puppeteer" aria-hidden="true" class="header-anchor">#</a> php 中使用 puppeteer</h3> <p>然后就是放到PHP代码里面。这里我就直接截取了部分代码讲一下思路。</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// 图片保存地址</span>
<span class="token variable">$imgFilePath</span> <span class="token operator">=</span> <span class="token function">storage_path</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;app/public/activity-record/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$activityRecord</span><span class="token punctuation">}</span></span>_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$template</span><span class="token punctuation">}</span></span>.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// js保存地址</span>
<span class="token variable">$jsFilePath</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/public/activity-record/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$activityRecord</span><span class="token punctuation">}</span></span>_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$template</span><span class="token punctuation">}</span></span>.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 访问地址</span>
<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'http://'</span> <span class="token punctuation">.</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'api.domains.mp'</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;/activity/record/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$activityRecord</span><span class="token punctuation">}</span></span>/share?template=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$template</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 创建文件</span>
<span class="token variable">$jsFileContents</span> <span class="token operator">=</span> <span class="token heredoc-string string"><span class="token delimiter symbol"><span class="token punctuation">&lt;&lt;&lt;</span>EOF</span>
const puppeteer = require('puppeteer');

(async () =&gt; {
const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox']});
const page = await browser.newPage();
await page.setViewport({ width: 375, height: 667, deviceScaleFactor: 2, isMobile: true });
await page.goto('<span class="token interpolation"><span class="token variable">$url</span></span>');
await page.screenshot({ path: '<span class="token interpolation"><span class="token variable">$imgFilePath</span></span>' });

await browser.close();
})();
<span class="token delimiter symbol">EOF<span class="token punctuation">;</span></span></span>

Storage<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">$jsFilePath</span><span class="token punctuation">,</span> <span class="token variable">$jsFileContents</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 主要也就是这一步比较的坑，填了很久很久</span>
<span class="token comment">// 正式的环境需要指定node目录</span>
<span class="token comment">// exec('/usr/local/nodejs/bin/node ' . storage_path(&quot;app/$jsFilePath&quot;));</span>
<span class="token comment">// 本地已经实现了</span>
<span class="token function">exec</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'node '</span> <span class="token punctuation">.</span> <span class="token function">storage_path</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;app/<span class="token interpolation"><span class="token variable">$jsFilePath</span></span>&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这里是上传到腾讯cos</span>
<span class="token variable">$disk</span> <span class="token operator">=</span> \<span class="token package">Storage</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'cosv5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$cosPath</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;jielong/activity/record/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$activityRecord</span><span class="token punctuation">}</span></span>/t/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$template</span><span class="token punctuation">}</span></span>.png&quot;</span><span class="token punctuation">;</span>

<span class="token variable">$disk</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">$cosPath</span><span class="token punctuation">,</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;<span class="token interpolation"><span class="token variable">$imgFilePath</span></span>&quot;</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>好了本地调试通过了，那就开始走测试环境，这里开始就不停的出现问题，依赖问题等等都出来了。</p> <h2 id="测试部署"><a href="#测试部署" aria-hidden="true" class="header-anchor">#</a> 测试部署</h2> <p>首先是测试换进 Centos 6.7 版本</p> <h3 id="依赖错误"><a href="#依赖错误" aria-hidden="true" class="header-anchor">#</a> 依赖错误</h3> <h4 id="libxcomposite-so-1"><a href="#libxcomposite-so-1" aria-hidden="true" class="header-anchor">#</a> libXcomposite.so.1</h4> <blockquote><p>error while loading shared libraries: libXcomposite.so.1: cannot open shared object file: No such file or directory</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>/home/puppeteer/node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome: error <span class="token keyword">while</span> loading shared libraries: libXcomposite.so.1: cannot <span class="token function">open</span> shared object file: No such <span class="token function">file</span> or directory
</code></pre></div><p><img src="/assets/img/image-20180914124705842.16ee0ab3.png" alt="image-20180914124705842"></p> <p><a href="https://github.com/GoogleChrome/puppeteer/issues/560#issuecomment-325224766" target="_blank" rel="noopener noreferrer">issuess<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code>// 安装依赖
yum <span class="token function">install</span> pango.x86_64 libXcomposite.x86_64 libXcursor.x86_64 libXdamage.x86_64 libXext.x86_64 libXi.x86_64 libXtst.x86_64 cups-libs.x86_64 libXScrnSaver.x86_64 libXrandr.x86_64 GConf2.x86_64 alsa-lib.x86_64 atk.x86_64 gtk3.x86_64 -y

// 安装字体
yum <span class="token function">install</span> ipa-gothic-fonts xorg-x11-fonts-100dpi xorg-x11-fonts-75dpi xorg-x11-utils xorg-x11-fonts-cyrillic xorg-x11-fonts-Type1 xorg-x11-fonts-misc -y
</code></pre></div><h4 id="libatk-bridge-2-0-so-0"><a href="#libatk-bridge-2-0-so-0" aria-hidden="true" class="header-anchor">#</a> libatk-bridge-2.0.so.0</h4> <blockquote><p>error while loading shared libraries: libatk-bridge-2.0.so.0: cannot open shared object file: No such file or directory</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>/home/puppeteer/node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome: error <span class="token keyword">while</span> loading shared libraries: libatk-bridge-2.0.so.0: cannot <span class="token function">open</span> shared object file: No such <span class="token function">file</span> or directory
</code></pre></div><p><img src="/assets/img/image-20180914125130578.4ab92e91.png" alt="image-20180914125130578"></p> <div class="language-bash extra-class"><pre class="language-bash"><code>ldd node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome
</code></pre></div><p><img src="/assets/img/image-20180914130912067.0a1994d7.png" alt="image-20180914130912067"></p> <div class="language-bash extra-class"><pre class="language-bash"><code>// 网上发现了一个方式，安装一个 firefox 然后把依赖复制过去
yum <span class="token function">install</span> firefox-60.1.0-6.el6.centos.x86_64

<span class="token function">cp</span> /usr/lib64/firefox/bundled/lib64/libatk-bridge-2.0.so.0 /usr/lib64
<span class="token function">cp</span> /usr/lib64/firefox/bundled/lib64/libatspi.so.0 /usr/lib64
<span class="token function">cp</span> /usr/lib64/firefox/bundled/lib64/libgdk-3.so.0 /usr/lib64
<span class="token function">cp</span> /usr/lib64/firefox/bundled/lib64/libgtk-3.so.0 /usr/lib64
</code></pre></div><p><img src="/assets/img/image-20180914133816963.287553f5.png" alt="image-20180914133816963"></p> <h4 id="libgl-so-1"><a href="#libgl-so-1" aria-hidden="true" class="header-anchor">#</a> libGL.so.1</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>/home/puppeteer/node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome: error <span class="token keyword">while</span> loading shared libraries: libGL.so.1: cannot <span class="token function">open</span> shared object file: No such <span class="token function">file</span> or directory
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> mesa-libGL.x86_64
</code></pre></div><p><img src="/assets/img/image-20180914133937739.9375e121.png" alt="image-20180914133937739"></p> <p>运行下面的命令行可以看到需要 GLIBC_2.14 GLIBC_2.16</p> <div class="language-bash extra-class"><pre class="language-bash"><code>objdump -p node_modules/puppeteer/.local-chromium/linux-588429/chrome-linux/chrome
</code></pre></div><p><img src="/assets/img/image-20180914132319923.fd90b0fe.png" alt="image-20180914132319923"></p> <p>发现只支持到 GLIBC_2.12</p> <div class="language-bash extra-class"><pre class="language-bash"><code>strings /lib64/libc.so.6 <span class="token operator">|</span><span class="token function">grep</span> GLIBC_ 
</code></pre></div><p><img src="/assets/img/image-20180914132530077.b26f575d.png" alt="image-20180914132530077"></p> <p>所以需要安装 GLIBC_2.14</p> <p><a href="https://www.cnblogs.com/kevingrace/p/8744417.html" target="_blank" rel="noopener noreferrer">libc.so.6: version 'GLIBC_2.14' not found报错提示的解决方案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>但是GLIBC_2.16在机器上怎么装都装不上，所以后来放弃了。</p> <p>解决方案是安装低版本的puppeteer 大概是 1.4 以下的版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cnpm i puppeteer@1.4
</code></pre></div><p>好像没有找到不需要 GLIBC_2.14 的包</p> <p>最后是安装了 GLIBC_2.14 然后执行命令之后发现了一个问题。</p> <h3 id="版本错误"><a href="#版本错误" aria-hidden="true" class="header-anchor">#</a> 版本错误</h3> <h4 id="libcairo-gobject-so-2-undefined-symbol-cairo-region-destroy"><a href="#libcairo-gobject-so-2-undefined-symbol-cairo-region-destroy" aria-hidden="true" class="header-anchor">#</a> libcairo-gobject.so.2: undefined symbol: cairo_region_destroy</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>libcairo-gobject.so.2: undefined symbol: cairo_region_destroy
</code></pre></div><p>后面反正是没有找到解决方案。</p> <h2 id="docker-部署"><a href="#docker-部署" aria-hidden="true" class="header-anchor">#</a> Docker 部署</h2> <h3 id="centos-安装-docker"><a href="#centos-安装-docker" aria-hidden="true" class="header-anchor">#</a> centos 安装 docker</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> docker-io
<span class="token function">service</span> docker start
vim Dockerfile
</code></pre></div><h3 id="docker-build-容器"><a href="#docker-build-容器" aria-hidden="true" class="header-anchor">#</a> docker build 容器</h3> <div class="language-dockerfile extra-class"><pre class="language-text"><code>FROM node:8-slim

# See https://crbug.com/795759
RUN apt-get update &amp;&amp; apt-get install -yq libgconf-2-4

# Install latest chrome dev package and fonts to support major charsets (Chinese, Japanese, Arabic, Hebrew, Thai and a few others)
# Note: this installs the necessary libs to make the bundled version of Chromium that Puppeteer
# installs, work.
RUN apt-get update &amp;&amp; apt-get install -y wget --no-install-recommends \
    &amp;&amp; wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - \
    &amp;&amp; sh -c 'echo &quot;deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main&quot; &gt;&gt; /etc/apt/sources.list.d/google.list' \
    &amp;&amp; apt-get update \
    &amp;&amp; apt-get install -y google-chrome-unstable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst ttf-freefont \
      --no-install-recommends \
    &amp;&amp; rm -rf /var/lib/apt/lists/* \
    &amp;&amp; apt-get purge --auto-remove -y curl \
    &amp;&amp; rm -rf /src/*.deb

# It's a good idea to use dumb-init to help prevent zombie chrome processes.
ADD https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64 /usr/local/bin/dumb-init
RUN chmod +x /usr/local/bin/dumb-init

# Uncomment to skip the chromium download when installing puppeteer. If you do,
# you'll need to launch puppeteer with:
#     browser.launch({executablePath: 'google-chrome-unstable'})
# ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD true

# Install puppeteer so it's available in the container.
RUN npm i puppeteer

# Add user so we don't need --no-sandbox.
RUN groupadd -r pptruser &amp;&amp; useradd -r -g pptruser -G audio,video pptruser \
    &amp;&amp; mkdir -p /home/pptruser/Downloads \
    &amp;&amp; chown -R pptruser:pptruser /home/pptruser \
    &amp;&amp; chown -R pptruser:pptruser /node_modules

# Run everything after as non-privileged user.
USER pptruser

ENTRYPOINT [&quot;dumb-init&quot;, &quot;--&quot;]
CMD [&quot;google-chrome-unstable&quot;]
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t puppeteer-chrome-linux <span class="token keyword">.</span>
</code></pre></div><h3 id="创建-puppeteer-sh"><a href="#创建-puppeteer-sh" aria-hidden="true" class="header-anchor">#</a> 创建 puppeteer.sh</h3> <p>然后创建了一个文件 puppeteer.sh</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token function">readonly</span> USAGE<span class="token operator">=</span><span class="token string">&quot;Usage: puppeteer.sh yourfile.js&quot;</span>

basepath<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">pwd</span><span class="token variable">)</span></span>

local_path<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$basepath</span>/storage/app/public/activity-record/&quot;</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
  <span class="token keyword">echo</span> <span class="token string">&quot;File not specified.&quot;</span>
  <span class="token keyword">echo</span> <span class="token variable">$USAGE</span>
  <span class="token keyword">exit</span> 0
<span class="token keyword">fi</span>

<span class="token keyword">echo</span> <span class="token string">&quot;Running <span class="token variable">$1</span> in Puppeteer...&quot;</span>

file<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $1<span class="token variable">`</span></span>

<span class="token comment"># set -x # debug on</span>
docker run -it --net<span class="token operator">=</span>host -v <span class="token variable">$local_path</span>:/home/pptruser/Downloads --privileged<span class="token operator">=</span>true --rm --cap-add<span class="token operator">=</span>SYS_ADMIN \
  --name puppeteer-chrome puppeteer-chrome-linux \
  node -e <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span>
</code></pre></div><h3 id="puppeteer-sh-生成图片"><a href="#puppeteer-sh-生成图片" aria-hidden="true" class="header-anchor">#</a> puppeteer.sh 生成图片</h3> <p>使用 puppeteer.sh 来调用 example.js</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./puppeteer.sh example.js
</code></pre></div><h3 id="php-去调用-puppeteer-sh"><a href="#php-去调用-puppeteer-sh" aria-hidden="true" class="header-anchor">#</a> php 去调用 puppeteer.sh</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">exec</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;./puppeteer.sh example.js&quot;</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>思考: php 如何使用 root 权限</p></blockquote> <p>会发现一个问题，在命令行的时候是可以执行的，但是在网页上面是不行，最后发现是权限问题。命令行是 root 权限但是在网站的时候是 www 权限，因为权限是通过 nginx 的用户来定的。然后又想到一个方法是用队列执行，队列是可以使用 root 权限去执行的，没想到是可以的。但是队列获取不到队列执行的结果，所以每次执行一次就不能用了，需要手动的重启队列，最后还是放弃了。</p> <h2 id="正式部署"><a href="#正式部署" aria-hidden="true" class="header-anchor">#</a> 正式部署</h2> <p>Centos 7.4 一切没有问题。</p> <p>主要是一个问题，生成图片的时候文字有方格乱码，解决的方案是使用本地的字体库。</p> <p>目前使用队列来执行代码，但是无法实时的更新，所以尝试 sleep 方法，但是还是不能很好的解决这个问题。</p> <p>思考后 node express 开发一个 api 来生成图片。</p> <h3 id="安装-express-puppeteer-等工具"><a href="#安装-express-puppeteer-等工具" aria-hidden="true" class="header-anchor">#</a> 安装 express puppeteer 等工具</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> /home/www/puppeteer
<span class="token function">cd</span> /home/www/puppeteer
// chrome 无头
cnpm i puppeteer
// 腾讯cos
cnpm i cos-nodejs-sdk-v5 --save
// express
cnpm i express
// 环境变量
cnpm i dotenv
// pm2进程管理
cnpm <span class="token function">install</span> pm2 -g
</code></pre></div><h3 id="express-搭建-api-服务器"><a href="#express-搭建-api-服务器" aria-hidden="true" class="header-anchor">#</a> express 搭建 api 服务器</h3> <p>index.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 引入json解析中间件</span>
<span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">COS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cos-nodejs-sdk-v5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> basePath <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> dotenv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/../jielong_mp/.env`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> cos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">COS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    AppId<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COSV5_APP_ID</span><span class="token punctuation">,</span>
    SecretId<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COSV5_SECRET_ID</span><span class="token punctuation">,</span>
    SecretKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COSV5_SECRET_KEY</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// COSV5_APP_ID = 1251581441</span>
<span class="token comment">// COSV5_SECRET_ID = AKIDbFnBPV9N6g8PYY91TkJp6D92pT0NIpoc</span>
<span class="token comment">// COSV5_SECRET_KEY = mOp9MRMF2eN0Tq26zhEaZO3XsJk3CA1i</span>
<span class="token comment">// COSV5_TIMEOUT = 60</span>
<span class="token comment">// COSV5_CONNECT_TIMEOUT = 60</span>
<span class="token comment">// COSV5_BUCKET = kemanyun</span>
<span class="token comment">// COSV5_REGION = ap - shanghai</span>
<span class="token comment">// COSV5_CDN = #https://{your-bucket-name}-{your-app-id}.file.myqcloud.com</span>
<span class="token comment">// COSV5_SCHEME = https</span>

<span class="token comment">// 添加json解析</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>extended<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/puppeteer'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> activity_record_id <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>activity_record_id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> template <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>template<span class="token punctuation">;</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/../jielong_mp/storage/app/public/activity-record/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>activity_record_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> mp_domain <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MP_DOMAIN</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`http:/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mp_domain<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/activity/record/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>activity_record_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/share?template=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">,</span> <span class="token string">'--disable-setuid-sandbox'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_ENV</span> <span class="token operator">===</span> <span class="token string">'local'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setViewport</span><span class="token punctuation">(</span><span class="token punctuation">{</span> width<span class="token punctuation">:</span> <span class="token number">375</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">667</span><span class="token punctuation">,</span> deviceScaleFactor<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> isMobile<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">screenshot</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 分片上传</span>
        <span class="token keyword">await</span> cos<span class="token punctuation">.</span><span class="token function">sliceUploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            Bucket<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COSV5_BUCKET</span><span class="token punctuation">,</span>
            Region<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COSV5_REGION</span><span class="token punctuation">,</span>
            Key<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COSV5_BUCKET_PREFIX</span> <span class="token operator">+</span> <span class="token template-string"><span class="token string">`/activity/record/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>activity_record_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/t/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png`</span></span><span class="token punctuation">,</span>
            FilePath<span class="token punctuation">:</span> path
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> <span class="token string">'创建图片成功'</span><span class="token punctuation">,</span>
            status_code<span class="token punctuation">:</span> <span class="token string">'201'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Example app listening on port 3000!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="pm2-来管理-express"><a href="#pm2-来管理-express" aria-hidden="true" class="header-anchor">#</a> pm2 来管理 express</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>pm2 start index.js
</code></pre></div><p><img src="/assets/img/image-20180914140355472.15404fd7.png" alt="image-20180914140355472"></p> <h3 id="php-调用接口来实现"><a href="#php-调用接口来实现" aria-hidden="true" class="header-anchor">#</a> php 调用接口来实现</h3> <div class="language-php extra-class"><pre class="language-php"><code>
<span class="token keyword">use</span> <span class="token package">GuzzleHttp<span class="token punctuation">\</span>Client</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token variable">$guzzleCLient</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$guzzleCLient</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'http://127.0.0.1:3000/api/puppeteer'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'form_params'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'activity_record_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$activityRecord</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'template'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$template</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="扩展分享"><a href="#扩展分享" aria-hidden="true" class="header-anchor">#</a> 扩展分享</h2> <p>最后我才发现了已经有大神有解决方案了，干得漂亮。</p> <p><a href="https://github.com/nesk/rialto" target="_blank" rel="noopener noreferrer">nesk/rialto<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 工作原理是创建一个Node进程并通过 socket 与它通信。</p> <p><a href="https://laravel-china.org/topics/14699/extended-recommendation-php-bridge-of-puphpeteerchrome-headless-browser-puphpeteer-project" target="_blank" rel="noopener noreferrer">Puphpeteer：Chrome 无头浏览器 Puphpeteer 项目的 PHP 桥梁<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>目前线上使用接口，没有使用这个包</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/6.351126f6.js" defer></script><script src="/assets/js/app.e418f3b2.js" defer></script>
  </body>
</html>
